language: ruby
cache:
  bundler: true
  apt: true
  directories:
    - node_modules
    - client_node_modules
    # - $(npm config get prefix)/bin/bower
    # - $(npm config get prefix)/bin/tsd
    # - $(npm config get prefix)/bin/tslint
    # - $(npm config get prefix)/bin/gulp
addons:
  postgresql: '9.4'
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - zsh
      - g++-4.8
env:
  global:
    - CXX=g++-4.8
    - secure: G8NSqBVJVX4mLrsWKDZh9eUMhlQrs/9z+9gAu8YC7mQ8ed0BlY4idrNI5vaD/+LsKSxEqhYO7U08Tn3KrtSo1sr7sSI47F1g/F8VCMXQW2eC89BiZh+9Td1qETvsW/jTFpF5QaQJBf5d6WBlpVp98KQOlLvUIL+Kyl08hhRmk/k=
before_install:
  - export TZ=Europe/Zurich
  - export CHROME_BIN=chromium-browser
  - export DISPLAY=:99.0
  - sh -e /etc/init.d/xvfb start
  - git clone https://github.com/renuo/renuo-cms-api.git && (cd renuo-cms-api && git checkout $(cat ../renuo-cms-api-branch))
  - git clone https://github.com/renuo/renuo-cms-client.git && (cd renuo-cms-client && git checkout $(cat ../renuo-cms-client-branch))
  - mv client_node_modules renuo-cms-client/node_modules || echo 'cache does not exist'
  - rm renuo-cms-client/npm-shrinkwrap.json
  - nvm install
  - npm install -g protractor
  - webdriver-manager update --standalone --firefox
  - webdriver-manager start 2>&1 &
  - npm install -g bower tsd tslint gulp
install:
  - (cd renuo-cms-api && bundle install --without production development --deployment --jobs=3 --retry=3)
  - (cd renuo-cms-client && npm install)
before_script:
  - psql -c 'create database travis_ci_test;' -U postgres
  - cp renuo-cms-api/config/database.travis.yml renuo-cms-api/config/database.yml
  - cp renuo-cms-api/config/application.travis.yml renuo-cms-api/config/application.yml
  - echo {\"token\":\"$TSDRC_TOKEN\"} > .tsdrc
  - (cd renuo-cms-client && tsd reinstall --save --overwrite)
script:
  - cd renuo-cms-api && rails s &
  - cd ..
  - cd renuo-cms-client && gulp travis-serve &
  - cd ..
  - (cd renuo-cms-client && protractor e2e/protractor-config.js)
  #  - (cd renuo-cms-api && bin/check)
  #  - (cd renuo-cms-client && npm test)
after_script: mv renuo-cms-client/node_modules client_node_modules

